# これで送迎 - 送迎スケジューリングアプリケーション

施設での利用者送迎計画を最適化するためのアプリケーションです。職員、利用者、車両の情報を入力することで、最適な送迎ルートとシフトを自動的に計算します。

## 機能

- 職員情報管理（名前、運転可能か、勤務曜日など）
- 利用者情報管理（名前、住所、通所曜日、特記事項など）
- 車両情報管理（車両名、乗車可能人数）
- 送迎ルートの最適化（OR-Toolsを使用）
- 曜日ごと、時間帯（朝/夕方）ごとの送迎スケジュール表示
- **Google Mapsを使用したルート表示**
- **送迎スケジュールのExcel出力**
- **職員・利用者・車両データのExcelインポート/エクスポート**
- **ChatGPTを使用したスケジュールチェック機能**

## 必要条件

- Python 3.7以上
- 必要なライブラリ（requirements.txtを参照）

## インストール方法

1. リポジトリをクローンまたはダウンロードする
2. 必要なライブラリをインストールする
   ```
   pip install -r requirements.txt
   ```
   以下のライブラリがインストールされます：
   - openpyxl (バージョン3.0.0以上): Excelファイルの読み書きに使用
   - ortools (バージョン9.0.0以上): 送迎ルートの最適化計算に使用
   - folium (バージョン0.12.0以上): 地図表示に使用
   - tkinter: GUIインターフェースの構築に使用
   - requests: API通信に使用
   - googlemaps: Google Maps APIとの連携に使用
   - python-dotenv: 環境変数の管理に使用
   - matplotlib: グラフ描画に使用

3. 設定ファイルの準備
   - `data/settings.json.sample` ファイルを `data/settings.json` にコピーします。
   ```
   cp data/settings.json.sample data/settings.json
   ```
   - `data/settings.json` ファイルを編集して、実際の情報を入力します。
   - 特に `api_key` フィールドには、Google Maps APIキーを設定してください。

## Google Maps APIキーの取得方法

1. [Google Cloud Platform Console](https://console.cloud.google.com/) にアクセスします。
2. プロジェクトを作成または選択します。
3. ナビゲーションメニューから「APIとサービス」>「ライブラリ」を選択します。
4. 以下のAPIを有効にします：
   - Maps JavaScript API
   - Directions API
   - Distance Matrix API
   - Geocoding API
5. 「APIとサービス」>「認証情報」から、APIキーを作成します。
6. 作成したAPIキーを `data/settings.json` ファイルの `api_key` フィールドに設定します。
7. セキュリティのため、APIキーに適切な制限（HTTPリファラー制限など）を設定することをお勧めします。

## 使い方

1. アプリケーションを起動する
   ```
   python src/main.py
   ```

2. サンプルデータを含めて起動する場合
   ```
   python src/main.py --sample
   ```

3. 各タブの説明
   - **職員タブ**: 送迎に関わる職員情報を登録・管理します。
   - **利用者タブ**: 送迎が必要な利用者の情報を登録・管理します。
   - **車両タブ**: 使用する車両情報を登録・管理します。
   - **送迎スケジュールタブ**: 登録された情報をもとに最適な送迎ルートを計算・表示します。
   - **設定タブ**: 施設の住所やAPIキーなどの基本設定を行います。

4. 最適化ステップ
   1. まず「職員」「利用者」「車両」タブで必要な情報を入力します。
   2. 「設定」タブで施設の住所を入力します。
   3. 「送迎スケジュール」タブで「送迎ルート最適化」ボタンをクリックします。
   4. 最適化が完了すると、曜日と時間帯ごとの送迎ルートが表示されます。

5. 新機能の使い方
   - **地図表示**: 送迎ルートを地図上で確認するには、「地図表示」ボタンをクリックします。
   - **Excel出力**: 送迎スケジュールをExcelで出力するには、「Excel」ボタンをクリックします。
   - **ChatGPTチェック**: スケジュールをChatGPTでチェックするには、「ChatGPTチェック用」ボタンをクリックし、生成されたテキストファイルをChatGPTに貼り付けてください。
   - **データのインポート/エクスポート**: 各タブ（職員、利用者、車両）にある「Excelエクスポート」「Excelインポート」ボタンを使用してデータの入出力が可能です。

## ChatGPTを使用したスケジュールチェック方法

1. 「送迎スケジュール」タブで「ChatGPTチェック用」ボタンをクリックします。
2. 生成されたテキストファイル（通常は`data/exports/chatgpt_check.txt`に保存）を開きます。
3. ファイルの内容をコピーし、[OpenAI ChatGPT](https://chat.openai.com/)に貼り付けます。
4. ChatGPTに「このスケジュールに問題点や改善点があれば教えてください」などと質問します。
5. ChatGPTの回答を参考に、必要に応じてスケジュールを調整します。

以下は、ChatGPTに送信するテキストの例です：
```
以下の送迎スケジュールを分析し、問題点や最適化の可能性について教えてください：

月曜日 朝の送迎
車両1: 運転者 山田太郎
- 8:15 施設出発
- 8:30 佐藤花子 ピックアップ（車いす使用）
- 8:45 鈴木一郎 ピックアップ
- 9:00 施設到着

車両2: 運転者 田中次郎
...

このスケジュールについて以下の点を確認してください：
1. 時間配分は適切か
2. 特別なニーズ（車いすなど）への対応は適切か
3. 運転者の配置は効率的か
4. 改善できる点はあるか
```

## 注意事項

- 実際の道路状況や交通状況によって所要時間は変動します。
- Google Maps APIキーを入力すると、より正確なルート計算と地図表示が可能になります。
  （キーがない場合はダミーデータで動作します）
- 最適化結果は常に完璧ではないため、必要に応じて手動で調整してください。
- Google Maps APIには使用量制限があります。頻繁に最適化を実行すると、APIの使用量制限に達する可能性があるので注意してください。

## 技術情報

- UI: tkinter（Pythonの標準GUIライブラリ）
- 最適化エンジン: Google OR-Tools
- 距離計算: Google Maps Distance Matrix API（オプション）
- 地図表示: Google Maps JavaScript API
- 出力形式: Excel (openpyxl)

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。
